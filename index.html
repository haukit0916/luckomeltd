<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>FunFun每週營運儀表板</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --grid:#233046;
      --line:#22d3ee; --ma:#a78bfa; --bar-std:#22d3ee; --bar-giant:#38bdf8; --bar-mini:#60a5fa;
      --border:rgba(148,163,184,.2); --thead:rgba(255,255,255,.03); --highlight:rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    body{ margin:0; background:linear-gradient(180deg,#0b1022 0%, #0f172a 100%); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Helvetica Neue", Arial; }
    header{ padding:16px 16px 0; max-width:1200px; margin:0 auto; }
    h1{ font-size:clamp(18px,4vw,24px); margin:0 0 6px; font-weight:700; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:clamp(12px,2.5vw,14px); margin:0 0 12px; }
    .wrap{ max-width:1200px; margin:0 auto; padding:12px 16px 28px; display:grid; gap:18px; }
    .panel{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .title-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
    .title{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:8px; background:rgba(167,139,250,.08); border:1px solid rgba(167,139,250,.35);
      color:#e9d5ff; padding:6px 10px; border-radius:999px; font-size:12px; }
    .controls, .table-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="number"], input[type="search"], select{
      appearance:none; border:1px solid var(--border); background:#1f2937; color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:13px; min-width:120px; outline:none;
    }
    input[type="file"]{ color:var(--muted); font-size:12px; background:rgba(255,255,255,.03);
      border:1px dashed var(--border); padding:6px 10px; border-radius:10px; }
    .btn{ appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:13px; cursor:pointer; }
    .btn.primary{ background:linear-gradient(180deg, rgba(34,211,238,.25), rgba(34,211,238,.08)); border-color: rgba(34,211,238,.55); }
    .btn.active{ border-color: rgba(34,211,238,.55); box-shadow: 0 0 0 2px rgba(34,211,238,.25) inset; }
    .kpis{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin:8px 0; }
    .kpi{ background:rgba(34,211,238,.06); border:1px solid rgba(34,211,238,.35); border-radius:10px; padding:10px; }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted); font-weight:500; }
    .kpi .val{ font-size:18px; font-weight:700; letter-spacing:.3px; margin-top:4px; }
    .kpi .delta{ font-size:12px; margin-top:2px; color:var(--muted); }
    .chart-wrap{ position:relative; width:100%; aspect-ratio: 16/9; min-height:260px; }
    canvas{ width:100% !important; height:100% !important; }
    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:10px; max-height:360px; background:rgba(0,0,0,.06); }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; font-size:12px; color:var(--text); vertical-align:top; }
    th{ color:#cbd5e1; background:var(--thead); position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.02); }
    tbody tr:hover{ background:var(--highlight); }
    .goods-cell{ white-space:pre-wrap; word-break:break-word; }
    footer{ max-width:1200px; margin:8px auto 24px; padding:0 16px; color:var(--muted); font-size:12px; }
    @media (max-width:860px){
      .kpis{ grid-template-columns:1fr; }
      .chart-wrap{ aspect-ratio: 4/3; min-height:240px; }
      .table-wrap{ max-height:300px; }
      .controls > * { min-width: unset; }
      input[type="file"]{ width:100%; }
      #searchBox{ min-width: 140px; flex: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>FunFun每週營運儀表板</h1>
  </header>

  <div class="wrap">
    <!-- 全局控制 -->
    <section class="panel">
      <div class="title-row">
        <div class="title">
          <span class="badge">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v12m0 0l-4-4m4 4l4-4M4 21h16" stroke="#a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            上載/分店/樣板
          </span>
        </div>
        <div class="controls">
          <label for="uploadXlsx">上載樣板</label>
          <input id="uploadXlsx" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <label for="storeSelect">選擇分店</label>
          <select id="storeSelect"><option value="__default__">（測試資料）</option></select>
          <button id="downloadUnifiedTemplate" class="btn primary">下載樣板</button>
        </div>
      </div>
    </section>

    <!-- 圖1：日總營收折線圖 -->
    <section class="panel" id="panel-line">
      <div class="title-row">
        <div class="title">
          <span class="badge">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 3v18h18" stroke="#a78bfa" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 15l3-4 3 2 4-6" stroke="#a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            日總營收折線圖
          </span>
        </div>
        <div class="controls">
          <button class="btn" id="toggleMA" aria-pressed="true">顯示/隱藏 7日MA</button>
          <button class="btn" id="toggleMarkers" aria-pressed="true">顯示/隱藏 高低點</button>
          <label for="lineThreshold">合格線</label>
          <input id="lineThreshold" type="number" placeholder="輸入門檻（留空不顯示）" />
          <button class="btn" id="resetLineZoom">重置縮放</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <h3>週總營收</h3>
          <div class="val" id="kpiLineTotal">—</div>
          <div class="delta">合計</div>
        </div>
        <div class="kpi">
          <h3>日均營收</h3>
          <div class="val" id="kpiLineAvg">—</div>
          <div class="delta">平均/天</div>
        </div>
        <div class="kpi">
          <h3>最高 / 最低日</h3>
          <div class="val" id="kpiLineHiLo">—</div>
          <div class="delta" id="kpiLineHiLoSub">—</div>
        </div>
      </div>

      <div class="chart-wrap">
        <canvas id="lineChart"></canvas>
      </div>

      <div class="table-controls">
        <strong style="font-size:13px">每日資料表</strong>
      </div>
      <div class="table-wrap">
        <table id="lineTable">
          <thead><tr><th>日期</th><th>總營收</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 圖2：機器（投幣量＋上架貨品名稱） -->
    <section class="panel" id="panel-bar">
      <div class="title-row">
        <div class="title">
          <span class="badge">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 21h18" stroke="#a78bfa" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 17v-8M12 17V7M17 17v-5" stroke="#a78bfa" stroke-width="2" stroke-linecap="round"/>
            </svg>
            機器（投幣量＋上架貨品名稱）
          </span>
        </div>
        <div class="controls">
          - 系列
          <select id="filterSeries">
            <option value="ALL">全部</option>
            <option value="標準機">標準機</option>
            <option value="巨無霸">巨無霸</option>
            <option value="迷你機">迷你機</option>
          </select>
          - 顯示
          <select id="passFilter">
            <option value="ALL">全部</option>
            <option value="PASS">合格</option>
            <option value="FAIL">不合格</option>
          </select>
          - 排序
          <select id="sortBy">
            <option value="total-desc">投幣量：高→低</option>
            <option value="total-asc">投幣量：低→高</option>
            <option value="name-asc">名稱：A→Z</option>
            <option value="name-desc">名稱：Z→A</option>
            <option value="goods-asc">上架貨品（名稱）：A→Z</option>
            <option value="goods-desc">上架貨品（名稱）：Z→A</option>
          </select>
          - 顯示數量
          <select id="topn">
            <option>全部</option><option>3</option><option>5</option><option>10</option><option>20</option>
          </select>
          <input id="searchBox" type="search" placeholder="搜尋機器名稱（例如：MB05、MBS03左）" />
          <label for="barThreshold">合格線（投幣量）</label>
          <input id="barThreshold" type="number" placeholder="輸入門檻（留空不顯示）" />
          <button id="resetBar" class="btn">重置</button>
        </div>
      </div>

      <div class="kpis" id="barKpis">
        <div class="kpi">
          <h3>合格/未達</h3>
          <div class="val" id="kpiBarPass">—</div>
          <div class="delta" id="kpiBarPassSub">請輸入合格線（以投幣量比較）</div>
        </div>
        <div class="kpi">
          <h3>顯示筆數</h3>
          <div class="val" id="kpiBarCount">—</div>
          <div class="delta">符合篩選與搜尋</div>
        </div>
      </div>

      <div class="chart-wrap">
        <canvas id="barChart"></canvas>
      </div>

      <div class="table-controls">
        <strong style="font-size:13px">機器資料表</strong>
      </div>
      <div class="table-wrap">
        <table id="dataTable">
          <thead><tr><th>名稱</th><th>系列</th><th>投幣量</th><th>上架貨品（名稱）</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

 
  <!-- 以 CDN 載入 SheetJS -->
  <script>
    const loadXLSX = (()=> {
      let p=null;
      return ()=>{
        if(p) return p;
        p = new Promise((resolve, reject)=>{
          const s=document.createElement('script');
          s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
          s.onload=()=>resolve(window.XLSX);
          s.onerror=()=>reject(new Error('無法載入 XLSX 程式庫（請確認網路或允許CDN）'));
          document.head.appendChild(s);
        });
        return p;
      };
    })();
  </script>

  <script>
    // ===== 狀態與預設 =====
    const storesData = new Map(); // storeName -> { daily:[[date,total]..], machines:[{name,total,goods,category}] }
    let itemsDict = new Map();    // code -> name
    const fmt = n => Number(n||0).toLocaleString('zh-Hant-TW');
    const parseDateUTC = d => Date.parse(d + "T00:00:00Z");
    const norm = s => String(s||'').trim();

    // 預設 Items 與測試資料
    itemsDict = new Map([
      ['PDPC0001','可口可樂'],
      ['PDPC0002','雪碧'],
      ['SPORT01','運動飲料'],
      ['WATER01','礦泉水'],
      ['COFFEE01','咖啡'],
      ['TEA01','茶飲'],
      ['ENERGY01','能量飲']
    ]);
    storesData.set('__default__', {
      daily: [
        ["2024-05-06", 4120], ["2024-05-07", 3890], ["2024-05-08", 4215],
        ["2024-05-09", 3770], ["2024-05-10", 5330], ["2024-05-11", 6860], ["2024-05-12", 5920],
      ],
      machines: [
        {name:'MB01', total:820,  goods:'PDPC0001; PDPC0002', category:'標準機'},
        {name:'MBX02 巨無霸', total:1510, goods:'SPORT01', category:'巨無霸'},
        {name:'MB03', total:640,  goods:'WATER01, COFFEE01', category:''},      // 自動判斷為標準機
        {name:'MBS03左', total:880, goods:'TEA01', category:'迷你機'},
        {name:'MBS03右', total:740, goods:'ENERGY01', category:''}               // 自動判斷為迷你機
      ]
    });

    // ===== 物資名稱對照 =====
    function mapGoodsToNames(goodsRaw){
      const s = String(goodsRaw||'').trim();
      if(!s) return '';
      const parts = s.replace(/[\n;]/g, ',').split(',').map(x=>x.trim()).filter(Boolean);
      if(parts.length===0) return '';
      const names = parts.map(code=>{
        const key = norm(code);
        const mapped = itemsDict.get(key);
        return mapped ? mapped : code;
      });
      return Array.from(new Set(names)).join(', ');
    }

    // ===== 類別判斷 =====
    function inferCategory(name, raw){
      const given = norm(raw);
      if(given) return given;
      const n = (name||'').toUpperCase();
      if(/巨無霸/.test(name) || n.startsWith('MBX')) return '巨無霸';
      if(/迷你/.test(name) || n.startsWith('MBS')) return '迷你機';
      return '標準機';
    }

    // ===== XLSX 解析 =====
    function parseItemsSheet(ws, XLSX){
      const arr = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});
      if(!arr.length) return new Map();
      const header = arr[0].map(h=>String(h).trim().toLowerCase());
      const idxCode = header.findIndex(h=>['code','編號','物資編號','stock no','stockno','id'].includes(h));
      const idxName = header.findIndex(h=>['name','品名','名稱','item name','物資名稱'].includes(h));
      if(idxCode===-1 || idxName===-1) return new Map();
      const dict = new Map();
      for(const row of arr.slice(1)){
        const code = norm(row[idxCode]);
        const name = norm(row[idxName]);
        if(code && name) dict.set(code, name);
      }
      return dict;
    }

    function parseStoreSheet(ws, XLSX){
      const arr = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});
      const blocks=[]; let cur=[];
      for(const row of arr){
        const isEmpty = row.every(cell=>String(cell).trim()==='');
        if(isEmpty){ if(cur.length){ blocks.push(cur); cur=[]; } }
        else cur.push(row.map(v=>String(v).trim()));
      }
      if(cur.length) blocks.push(cur);
      if(blocks.length<2) throw new Error('該 Sheet 未發現兩個段落（每日、機器）。請以空白行分隔。');

      let daily=null, machines=null;
      const tryDaily=(blk)=>{
        const header = blk[0].map(h=>h.toLowerCase());
        const idxDate = header.findIndex(h=>['date','日期'].includes(h));
        const idxTotal = header.findIndex(h=>['total','sum','total_revenue','總營收','營收','value','amount'].includes(h));
        if(idxDate===-1 || idxTotal===-1) return null;
        const data = blk.slice(1).map(r=>[r[idxDate], Number(r[idxTotal]||0)])
          .filter(([d,v])=> /^\d{4}-\d{2}-\d{2}$/.test(d) && !isNaN(v))
          .sort((a,b)=>a[0].localeCompare(b[0]));
        return data.length? data : null;
      };
      const tryMachines=(blk)=>{
        const header = blk[0].map(h=>h.toLowerCase());
        const idxName = header.findIndex(h=>['name','機器','名稱'].includes(h));
        const idxTotal = header.findIndex(h=>['total','sum','週總計','total_revenue','amount','value','投幣量'].includes(h));
        const idxGoods = header.findIndex(h=>['goods','上架貨品','商品','品名','items','item'].includes(h));
        const idxCat  = header.findIndex(h=>['category','分類','系列','機型'].includes(h));
        if(idxName===-1 || idxTotal===-1) return null;
        const data = blk.slice(1).map(r=>({
          name:r[idxName],
          total:Number(r[idxTotal]||0),
          goods: idxGoods>-1 ? String(r[idxGoods]||'') : '',
          category: idxCat>-1 ? String(r[idxCat]||'') : ''
        })).filter(x=>x.name && !isNaN(x.total));
        return data.length? data : null;
      };

      for(const b of blocks){ if(!daily) daily=tryDaily(b); if(!machines) machines=tryMachines(b); }
      if(!daily) throw new Error('每日段落解析失敗（需含 date,total）');
      if(!machines) throw new Error('機器段落解析失敗（需含 name,total[,goods,category]）');
      return { daily, machines };
    }

    async function handleXlsxFile(file){
      const XLSX = await loadXLSX();
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});

      // Items
      let itemsSheetName = wb.SheetNames.find(n=>/^items$/i.test(n) || /物資/.test(n));
      if(itemsSheetName){
        try{
          const dict = parseItemsSheet(wb.Sheets[itemsSheetName], XLSX);
          if(dict.size) itemsDict = dict;
        }catch(e){ console.warn('Items 解析失敗：', e.message); }
      }

      const newStores = new Map();
      wb.SheetNames.forEach(name=>{
        if(name===itemsSheetName) return;
        const ws = wb.Sheets[name];
        try{
          const {daily, machines} = parseStoreSheet(ws, XLSX);
          const mapped = machines.map(m=>{
            const cat = inferCategory(m.name, m.category);
            return { name:m.name, total:m.total, goods: mapGoodsToNames(m.goods), category:cat };
          });
          newStores.set(name, { daily, machines: mapped });
        }catch(err){ /* 非分店表忽略 */ }
      });
      if(newStores.size===0) throw new Error('未成功解析任何分店資料，請檢查分店工作表格式。');
      for(const [k,v] of newStores) storesData.set(k, v);
      refreshStoreSelect(newStores.keys().next().value);
      alert(`XLSX 已載入：${newStores.size} 間分店；Items 對照共 ${itemsDict.size} 筆`);
    }

    // ===== 折線圖類（同前） =====
    class MiniLineChart {
      constructor(canvas, points, opts={}){
        this.canvas = canvas; this.ctx = canvas.getContext('2d');
        this.opts = Object.assign({ padding:{l:56,r:16,t:20,b:42}, showMA:true, showMarkers:true, threshold:null }, opts);
        this.setData(points); this._bind(); new ResizeObserver(()=>this.draw()).observe(canvas);
      }
      setData(points){
        this.points = points.slice();
        if(!this.points.length){ this.points=[{x:parseDateUTC('2024-05-06'), y:0}]; }
        const xs=this.points.map(p=>p.x), ys=this.points.map(p=>p.y);
        this.xMin=Math.min(...xs); this.xMax=Math.max(...xs);
        const yMin=Math.min(...ys), yMax=Math.max(...ys), pad=Math.max(1,(yMax-yMin)*0.1);
        this.yMin=Math.max(0, Math.floor(yMin-pad)); this.yMax=Math.ceil(yMax+pad);
        this.viewX={min:this.xMin,max:this.xMax}; this.hover=null; this.draw();
      }
      setShowMA(b){ this.opts.showMA=b; this.draw(); }
      setShowMarkers(b){ this.opts.showMarkers=b; this.draw(); }
      setThreshold(v){ this.opts.threshold=(v===''||v===null)? null : Number(v); this.draw(); }
      reset(){ this.viewX.min=this.xMin; this.viewX.max=this.xMax; this.draw(); }
      _bind(){
        this.canvas.addEventListener('mousemove', e=>this._onMove(e));
        this.canvas.addEventListener('mouseleave', ()=>{ this.hover=null; this.draw(); });
        this.canvas.addEventListener('wheel', e=>{
          e.preventDefault();
          const {left}=this.canvas.getBoundingClientRect(), px=e.clientX-left, ratio=(px-this.opts.padding.l)/(this.canvas.clientWidth-this.opts.padding.l-this.opts.padding.r);
          const x=this.viewX.min+ratio*(this.viewX.max-this.viewX.min), scale=e.deltaY<0?0.9:1.1;
          const newMin = x - (x - this.viewX.min)*scale, newMax = x + (this.viewX.max - x)*scale;
          const spanMin = (this.xMax - this.xMin) * 0.1;
          if(newMax-newMin>=spanMin){ this.viewX.min=Math.max(this.xMin,newMin); this.viewX.max=Math.min(this.xMax,newMax); this.draw(); }
        }, {passive:false});
        let dragging=false,lastX=0;
        this.canvas.addEventListener('mousedown', e=>{ dragging=true; lastX=e.clientX; });
        window.addEventListener('mouseup', ()=>dragging=false);
        window.addEventListener('mousemove', e=>{
          if(!dragging) return;
          const {width}=this.canvas.getBoundingClientRect(), dx=e.clientX-lastX; lastX=e.clientX;
          const span=this.viewX.max-this.viewX.min, shift=-dx/width*span;
          this.viewX.min=Math.max(this.xMin,this.viewX.min+shift); this.viewX.max=Math.min(this.xMax,this.viewX.max+shift);
          if(this.viewX.min<this.xMin){ const d=this.xMin-this.viewX.min; this.viewX.min+=d; this.viewX.max+=d; }
          if(this.viewX.max>this.xMax){ const d=this.viewX.max-this.xMax; this.viewX.min-=d; this.viewX.max-=d; }
          this.draw();
        });
        this.canvas.addEventListener('dblclick', ()=>this.reset());
      }
      _xToPx(x){ const {l,r}=this.opts.padding; const w=this.canvas.clientWidth-l-r; return l+((x-this.viewX.min)/(this.viewX.max-this.viewX.min))*w; }
      _yToPx(y){ const {t,b}=this.opts.padding; const h=this.canvas.clientHeight-t-b; return t+(1-(y-this.yMin)/(this.yMax-this.yMin))*h; }
      _niceTicks(min,max,count=5){ const span=max-min; if(span<=0) return [min]; const raw=span/count; const pow=10**Math.floor(Math.log10(raw));
        const mult=[1,2,2.5,5,10]; let step=mult[0]*pow; for(const m of mult){ if(raw<=m*pow){ step=m*pow; break; } }
        const start=Math.ceil(min/step)*step, out=[]; for(let v=start; v<=max; v+=step) out.push(v); return out;
      }
      _drawThreshold(ctx,rect){ const thr=this.opts.threshold; if(thr==null) return; const y=this._yToPx(thr); const {l,r}=this.opts.padding;
        ctx.save(); ctx.strokeStyle='rgba(239,68,68,.9)'; ctx.setLineDash([6,6]); ctx.lineWidth=1.5;
        ctx.beginPath(); ctx.moveTo(l,y); ctx.lineTo(rect.width-r,y); ctx.stroke();
        ctx.fillStyle='rgba(239,68,68,.9)'; ctx.font='12px ui-sans-serif, system-ui'; ctx.textAlign='left'; ctx.textBaseline='bottom';
        ctx.fillText(`合格線：${fmt(thr)}`, l+6, y-4); ctx.restore(); }
      draw(){
        const ctx=this.ctx; const dpr=window.devicePixelRatio||1; const rect=this.canvas.getBoundingClientRect();
        this.canvas.width=Math.round(rect.width*dpr); this.canvas.height=Math.round(rect.height*dpr); ctx.scale(dpr,dpr);
        ctx.clearRect(0,0,rect.width,rect.height); const {l,r,t,b}=this.opts.padding;

        const ticks=this._niceTicks(this.yMin,this.yMax,5);
        ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid').trim()||'#233046';
        ctx.lineWidth=1; ctx.beginPath(); for(const y of ticks){ const py=this._yToPx(y); ctx.moveTo(l,py); ctx.lineTo(rect.width-r,py); } ctx.stroke();
        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#94a3b8';
        ctx.font='12px ui-sans-serif, system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
        for(const y of ticks){ const py=this._yToPx(y); ctx.fillText(fmt(y), l-8, py); }

        ctx.textAlign='center'; ctx.textBaseline='top';
        for(const p of this.points){ const px=this._xToPx(p.x); const d=new Date(p.x); ctx.fillText(`${d.getUTCMonth()+1}/${d.getUTCDate()}`, px, rect.height-b+6); }

        ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--line').trim()||'#22d3ee';
        ctx.lineWidth=2; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.beginPath();
        let started=false; for(const p of this.points){ const px=this._xToPx(p.x), py=this._yToPx(p.y); if(!started){ctx.moveTo(px,py); started=true;} else ctx.lineTo(px,py); } ctx.stroke();

        if(this.opts.showMA){ const base=this.points; const k=7, ma=[];
          for(let i=0;i<base.length;i++){ const a=Math.max(0,i-k+1); const slice=base.slice(a,i+1); const avg=slice.reduce((s,p)=>s+p.y,0)/slice.length; ma.push({x:base[i].x,y:avg}); }
          ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ma').trim()||'#a78bfa';
          ctx.setLineDash([6,6]); ctx.lineWidth=1.8; ctx.beginPath(); let s=false;
          for(const p of ma){ const px=this._xToPx(p.x), py=this._yToPx(p.y); if(!s){ctx.moveTo(px,py); s=true;} else ctx.lineTo(px,py);} ctx.stroke(); ctx.setLineDash([]); }

        if(this.hover){ const {px,p}=this.hover; const tip=`${new Date(p.x).toISOString().slice(0,10)}｜${fmt(p.y)}`;
          const m=ctx.measureText(tip); const w=m.width+16,h=26; const x=Math.min(Math.max(px-w/2,10),rect.width-w-10); const y=t+6;
          ctx.fillStyle='rgba(17,24,39,.95)'; ctx.strokeStyle='rgba(148,163,184,.35)'; ctx.lineWidth=1; this._roundRect(ctx,x,y,w,h,8); ctx.fill(); ctx.stroke();
          ctx.fillStyle='#e5e7eb'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(tip, x+w/2, y+h/2);
        }

        this._drawThreshold(ctx,rect);
      }
      _onMove(e){ const {left}=this.canvas.getBoundingClientRect(); const px=e.clientX-left;
        let best=0,dist=Infinity; for(let i=0;i<this.points.length;i++){ const d=Math.abs(this._xToPx(this.points[i].x)-px); if(d<dist){best=i; dist=d;} }
        const p=this.points[best]; this.hover={px:this._xToPx(p.x), p}; this.draw(); }
      _roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); }
    }

    // ===== 長條圖（投幣量；提示僅顯示名稱；合格線）=====
    class BarChart {
      constructor(canvas){ this.canvas=canvas; this.ctx=canvas.getContext('2d');
        this.padding={l:70,r:20,t:18,b:54}; this.data=[]; this.viewMaxY=1; this.hoverIndex=-1; this.threshold=null;
        new ResizeObserver(()=>this.draw()).observe(canvas); this._bind(); }
      setData(data){
        this.data=data.slice();
        const maxVal=Math.max(1,...this.data.map(d=>d.total));
        this.viewMaxY=maxVal*1.1; this.draw();
      }
      setThreshold(v){ this.threshold=(v===''||v===null)? null : Number(v); this.draw(); }
      _bind(){ this.canvas.addEventListener('mousemove', e=>{ const {left}=this.canvas.getBoundingClientRect(); const x=e.clientX-left; this.hoverIndex=this._indexFromX(x); this.draw(); });
        this.canvas.addEventListener('mouseleave', ()=>{ this.hoverIndex=-1; this.draw(); });
        this.canvas.addEventListener('wheel', (e)=>{ e.preventDefault(); const scale=e.deltaY<0?0.9:1.1;
          const maxVal=Math.max(1,...this.data.map(d=>d.total)); const minMax=maxVal*1.02; this.viewMaxY=Math.max(minMax, this.viewMaxY*scale); this.draw(); }, {passive:false}); }
      _indexFromX(px){ if(!this.data.length) return -1; const rect=this.canvas.getBoundingClientRect(); const {l,r}=this.padding;
        const plotW=rect.width-l-r; const n=this.data.length; const cellW=plotW/n; const idx=Math.floor((px-l)/cellW); return (idx>=0&&idx<n)?idx:-1; }
      _yToPx(v){ const rect=this.canvas.getBoundingClientRect(); const {t,b}=this.padding; const h=rect.height-t-b; return t+(1-v/this.viewMaxY)*h; }
      _niceTicks(min,max,count=5){ const span=max-min; if(span<=0) return [min]; const raw=span/count; const pow=10**Math.floor(Math.log10(raw));
        const cand=[1,2,2.5,5,10]; let step=cand[0]*pow; for(const c of cand){ if(raw<=c*pow){ step=c*pow; break; } } const ticks=[]; for(let v=0; v<=max; v+=step) ticks.push(v); return ticks; }
      _wrapGoods(text, maxWidth, ctx){
        const sepNormalized = String(text||'').replace(/;/g, ',');
        const parts = sepNormalized.split(',').map(s=>s.trim()).filter(Boolean);
        const lines=[]; let current='';
        for(const part of parts.length? parts : [sepNormalized]){
          const candidate = current ? current + ', ' + part : part;
          if(ctx.measureText(candidate).width <= maxWidth){ current = candidate; }
          else{
            if(current) lines.push(current);
            if(ctx.measureText(part).width <= maxWidth){ current = part; }
            else{
              let buf=''; for(const ch of part){
                if(ctx.measureText(buf+ch).width <= maxWidth) buf+=ch;
                else{ if(buf) lines.push(buf); buf=ch; }
              }
              current = buf;
            }
          }
        }
        if(current) lines.push(current);
        return lines.length ? lines : ['—'];
      }
      draw(){
        const ctx=this.ctx; const dpr=window.devicePixelRatio||1; const rect=this.canvas.getBoundingClientRect();
        this.canvas.width=Math.round(rect.width*dpr); this.canvas.height=Math.round(rect.height*dpr); ctx.scale(dpr,dpr); ctx.clearRect(0,0,rect.width,rect.height);
        const {l,r,t,b}=this.padding; const plotW=rect.width-l-r; const plotH=rect.height-t-b;

        const ticks=this._niceTicks(0,this.viewMaxY,5);
        ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid').trim()||'#233046';
        ctx.lineWidth=1; ctx.beginPath(); for(const yv of ticks){ const py=this._yToPx(yv); ctx.moveTo(l,py); ctx.lineTo(rect.width-r,py); } ctx.stroke();
        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#94a3b8';
        ctx.font='12px ui-sans-serif, system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
        for(const yv of ticks){ const py=this._yToPx(yv); ctx.fillText(fmt(Math.round(yv)), l-8, py); }

        if(!this.data.length){ ctx.fillStyle='#e5e7eb'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('無資料（請選擇分店或調整篩選）', rect.width/2, rect.height/2); return; }

        if(this.threshold!=null){ const y=this._yToPx(this.threshold); ctx.save(); ctx.strokeStyle='rgba(239,68,68,.9)'; ctx.setLineDash([6,6]); ctx.lineWidth=1.5;
          ctx.beginPath(); ctx.moveTo(l,y); ctx.lineTo(rect.width-r,y); ctx.stroke();
          ctx.fillStyle='rgba(239,68,68,.9)'; ctx.textAlign='left'; ctx.textBaseline='bottom'; ctx.fillText(`合格線：${fmt(this.threshold)}`, l+6, y-4); ctx.restore(); }

        const n=this.data.length; const barW=(plotW/n)*0.78; const gap=(plotW/n)*0.22; let x=l+gap/2;
        const cStd = getComputedStyle(document.documentElement).getPropertyValue('--bar-std').trim()||'#22d3ee';
        const cGiant = getComputedStyle(document.documentElement).getPropertyValue('--bar-giant').trim()||'#38bdf8';
        const cMini = getComputedStyle(document.documentElement).getPropertyValue('--bar-mini').trim()||'#60a5fa';
        const colorOf = (cat)=> cat==='巨無霸'?cGiant : cat==='迷你機'?cMini : cStd;

        for(let i=0;i<n;i++){
          const d=this.data[i]; const bh=plotH*(d.total/this.viewMaxY); const y=t+(plotH-bh);
          ctx.fillStyle=colorOf(d.category); this._roundRect(ctx,x,y,barW,bh,6); ctx.fill();
          if(i===this.hoverIndex){
            ctx.save(); ctx.strokeStyle='rgba(255,255,255,.75)'; ctx.lineWidth=1; this._roundRect(ctx,x,y,barW,bh,6); ctx.stroke();
            const nameLine = `${d.name}｜投幣量 ${fmt(d.total)}`;
            ctx.font='12px ui-sans-serif, system-ui';
            const maxTipWidth = Math.min(320, rect.width-20);
            const goodsLines = this._wrapGoods(d.goods, maxTipWidth-16, ctx); // 僅顯示名稱，不加前綴
            const textLines=[nameLine, ...goodsLines];
            let tipW=0; for(const line of textLines){ tipW=Math.max(tipW, ctx.measureText(line).width); } tipW = Math.min(maxTipWidth, tipW) + 16;
            const lineH=18; const tipH=lineH*textLines.length + 8;
            const tx=Math.min(Math.max(x+barW/2-tipW/2,10),rect.width-tipW-10); const ty=t+6;
            ctx.fillStyle='rgba(17,24,39,.95)'; ctx.strokeStyle='rgba(148,163,184,.35)'; ctx.lineWidth=1; this._roundRect(ctx,tx,ty,tipW,tipH,8); ctx.fill(); ctx.stroke();
            ctx.fillStyle='#e5e7eb'; ctx.textAlign='left'; ctx.textBaseline='top';
            let cy=ty+4; for(const line of textLines){ ctx.fillText(line, tx+8, cy); cy+=lineH; }
            ctx.restore();
          }
          x+=barW+gap;
        }

        // X labels
        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#94a3b8';
        const rotate=n>18; ctx.textAlign=rotate?'right':'center'; ctx.textBaseline='top'; x=l+gap/2;
        for(let i=0;i<n;i++){ const d=this.data[i]; const lx=x+barW/2, ly=rect.height-b+6;
          if(rotate){ ctx.save(); ctx.translate(lx,ly); ctx.rotate(-Math.PI/4); ctx.fillText(d.name,0,0); ctx.restore(); } else { ctx.fillText(d.name,lx,ly); }
          x+=barW+gap; }
      }
      _roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
    }

    // ===== 應用層 =====
    const lineChart = new MiniLineChart(document.getElementById('lineChart'), []);
    const barChart  = new BarChart(document.getElementById('barChart'));
    const barState = { filterSeries:'ALL', pass:'ALL', sortBy:'total-desc', topn:'全部', query:'', threshold:null };
    let machineItems = [];

    function arrayToItems(arr){
      return arr.map(({name,total,goods,category})=>{
        const cat = inferCategory(name, category);
        const goodsNames = mapGoodsToNames(goods);
        return { name, category:cat, total:Number(total||0), goods: goodsNames };
      });
    }

    function setActiveStore(storeName){
      const store = storesData.get(storeName);
      if(!store) return;
      const dailyPts = store.daily.map(([d,v])=>({x:parseDateUTC(d), y:Number(v||0)}));
      lineChart.setData(dailyPts);
      refreshLineKPIsAndTable();
      machineItems = arrayToItems(store.machines);
      applyBarState();
    }

    function refreshStoreSelect(selectName){
      const sel = document.getElementById('storeSelect');
      const current = sel.value;
      sel.innerHTML='';
      const names = Array.from(storesData.keys()).sort((a,b)=>{
        if(a==='__default__') return -1; if(b==='__default__') return 1; return a.localeCompare(b,'zh-Hant');
      });
      for(const n of names){ const opt=document.createElement('option'); opt.value=n; opt.textContent=(n==='__default__'?'（測試資料）':n); sel.appendChild(opt); }
      sel.value = selectName || current || names[0];
      setActiveStore(sel.value);
    }

    function refreshLineKPIsAndTable(){
      const points = lineChart.points.slice().sort((a,b)=>a.x-b.x);
      const sum = points.reduce((s,p)=>s+p.y,0);
      const avg = sum / Math.max(1, points.length);
      let hi=0, lo=0; for(let i=1;i<points.length;i++){ if(points[i].y>points[hi].y) hi=i; if(points[i].y<points[lo].y) lo=i; }
      document.getElementById('kpiLineTotal').textContent = fmt(sum);
      document.getElementById('kpiLineAvg').textContent = fmt(Math.round(avg));
      if(points.length){ document.getElementById('kpiLineHiLo').textContent = `${fmt(points[hi].y)} / ${fmt(points[lo].y)}`;
        document.getElementById('kpiLineHiLoSub').textContent = `${new Date(points[hi].x).toISOString().slice(0,10)} 高；${new Date(points[lo].x).toISOString().slice(0,10)} 低`;
      } else { document.getElementById('kpiLineHiLo').textContent='—'; document.getElementById('kpiLineHiLoSub').textContent='—'; }
      const tbody = document.querySelector('#lineTable tbody'); tbody.innerHTML='';
      points.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(p.x).toISOString().slice(0,10)}</td><td>${fmt(p.y)}</td>`; tbody.appendChild(tr); });
    }

    function applyBarState(){
      let data = machineItems.slice();
      // 系列篩選
      if(barState.filterSeries!=='ALL') data = data.filter(d=>d.category===barState.filterSeries);
      // 合格/不合格篩選
      const thr = barState.threshold;
      if(barState.pass!=='ALL' && thr!=null && !isNaN(thr)){
        data = data.filter(d=> (barState.pass==='PASS') ? (d.total>=thr) : (d.total<thr) );
      }
      // 搜尋
      const q = barState.query.trim().toLowerCase();
      if(q) data = data.filter(d=>d.name.toLowerCase().includes(q));
      // 排序
      switch(barState.sortBy){
        case 'total-desc': data.sort((a,b)=>b.total-a.total); break;
        case 'total-asc': data.sort((a,b)=>a.total-b.total); break;
        case 'name-asc': data.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')); break;
        case 'name-desc': data.sort((a,b)=>b.name.localeCompare(a.name,'zh-Hant')); break;
        case 'goods-asc': data.sort((a,b)=>String(a.goods||'').localeCompare(String(b.goods||''),'zh-Hant')); break;
        case 'goods-desc': data.sort((a,b)=>String(b.goods||'').localeCompare(String(a.goods||''),'zh-Hant')); break;
      }
      // TopN
      if(barState.topn!=='全部'){ const n=parseInt(barState.topn,10); data=data.slice(0,n); }

      // KPI（合格線）
      document.getElementById('kpiBarCount').textContent = data.length.toString();
      if(thr==null || isNaN(thr)){
        document.getElementById('kpiBarPass').textContent = '—';
        document.getElementById('kpiBarPassSub').textContent = '請輸入合格線（以投幣量比較）';
      } else {
        const pass = data.filter(d=>d.total >= thr).length;
        const fail = data.length - pass;
        const rate = data.length ? Math.round(pass/data.length*100) : 0;
        document.getElementById('kpiBarPass').textContent = `${pass} / ${data.length}`;
        document.getElementById('kpiBarPassSub').textContent = `合格率 ${rate}%（未達 ${fail}）`;
      }

      // 表格
      const tbody = document.querySelector('#dataTable tbody'); tbody.innerHTML='';
      data.forEach(d=>{
        const tr=document.createElement('tr');
        const goodsText = d.goods ? d.goods : '—';
        tr.innerHTML = `<td>${d.name}</td><td>${d.category}</td><td>${fmt(d.total)}</td><td class="goods-cell">${goodsText}</td>`;
        tbody.appendChild(tr);
      });

      barChart.setData(data);
      barChart.setThreshold(barState.threshold);
    }

    // ===== 初始化：預設分店 goods 映射與分類補全 =====
    (function init(){
      const def = storesData.get('__default__');
      def.machines = def.machines.map(m=> ({...m, goods: mapGoodsToNames(m.goods), category: inferCategory(m.name, m.category)}));
      storesData.set('__default__', def);
      refreshStoreSelect('__default__');
    })();

    // ===== 事件綁定 =====
    document.getElementById('storeSelect').addEventListener('change', e=> setActiveStore(e.target.value));
    document.getElementById('uploadXlsx').addEventListener('change', async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      try{ await handleXlsxFile(file); }catch(err){ alert('XLSX 解析失敗：' + err.message); } finally { e.target.value=''; }
    });

    document.getElementById('toggleMA').addEventListener('click', (e)=>{
      const now=!lineChart.opts.showMA; lineChart.setShowMA(now);
      e.currentTarget.classList.toggle('active', now); e.currentTarget.setAttribute('aria-pressed', String(now));
    });
    document.getElementById('toggleMarkers').addEventListener('click', (e)=>{
      const now=!lineChart.opts.showMarkers; lineChart.setShowMarkers(now);
      e.currentTarget.classList.toggle('active', now); e.currentTarget.setAttribute('aria-pressed', String(now));
    });
    document.getElementById('lineThreshold').addEventListener('input', (e)=> lineChart.setThreshold(e.target.value===''? null : Number(e.target.value)));
    document.getElementById('resetLineZoom').addEventListener('click', ()=> lineChart.reset());

    document.getElementById('filterSeries').addEventListener('change', e=>{ barState.filterSeries=e.target.value; applyBarState(); });
    document.getElementById('passFilter').addEventListener('change', e=>{ barState.pass=e.target.value; applyBarState(); });
    document.getElementById('sortBy').addEventListener('change', e=>{ barState.sortBy=e.target.value; applyBarState(); });
    document.getElementById('topn').addEventListener('change', e=>{ barState.topn=e.target.value; applyBarState(); });
    document.getElementById('searchBox').addEventListener('input', e=>{ barState.query=e.target.value; applyBarState(); });
    document.getElementById('barThreshold').addEventListener('input', e=>{ const v=e.target.value; barState.threshold=(v===''? null : Number(v)); applyBarState(); });
    document.getElementById('resetBar').addEventListener('click', ()=>{
      document.getElementById('filterSeries').value='ALL';
      document.getElementById('passFilter').value='ALL';
      document.getElementById('sortBy').value='total-desc';
      document.getElementById('topn').value='全部';
      document.getElementById('searchBox').value='';
      document.getElementById('barThreshold').value='';
      barState.filterSeries='ALL'; barState.pass='ALL'; barState.sortBy='total-desc'; barState.topn='全部'; barState.query=''; barState.threshold=null;
      applyBarState();
    });

    // ===== 樣板下載（含 Items 與 category 欄）=====
    document.getElementById('downloadUnifiedTemplate').addEventListener('click', async ()=>{
      const XLSX = await loadXLSX();
      const wb = XLSX.utils.book_new();

      const items = [['code','name'],
        ['PDPC0001','可口可樂'], ['PDPC0002','雪碧'], ['SPORT01','運動飲料'],
        ['WATER01','礦泉水'], ['COFFEE01','咖啡'], ['TEA01','茶飲'], ['ENERGY01','能量飲']
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(items), 'Items');

      const makeStore=(storeName)=>{
        const daily = [['date','total'],
          ['2024-05-06',0],['2024-05-07',0],['2024-05-08',0],['2024-05-09',0],['2024-05-10',0],['2024-05-11',0],['2024-05-12',0]];
        const machines = [['name','total','goods','category'],  // total=投幣量
          ['MB01',0,'PDPC0001, PDPC0002','標準機'],
          ['MBX02 巨無霸',0,'SPORT01','巨無霸'],
          ['MB03',0,'WATER01, COFFEE01',''],   // 留空可自動判斷
          ['MBS03左',0,'TEA01','迷你機'],
          ['MBS03右',0,'ENERGY01','']
        ];
        const ws = XLSX.utils.aoa_to_sheet([...daily, [], ...machines]);
        XLSX.utils.book_append_sheet(wb, ws, storeName);
      };
      makeStore('店A'); makeStore('店B');

      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='stores_weekly_with_items_template.xlsx';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('downloadSingleStoreTemplate').addEventListener('click', async ()=>{
      const XLSX = await loadXLSX();
      const wb = XLSX.utils.book_new();

      const items = [['code','name'],
        ['PDPC0001','可口可樂'], ['PDPC0002','雪碧'], ['SPORT01','運動飲料'],
        ['WATER01','礦泉水'], ['COFFEE01','咖啡'], ['TEA01','茶飲'], ['ENERGY01','能量飲']
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(items), 'Items');

      const daily = [['date','total'],
        ['2024-05-06',0],['2024-05-07',0],['2024-05-08',0],['2024-05-09',0],['2024-05-10',0],['2024-05-11',0],['2024-05-12',0]];
      const machines = [['name','total','goods','category'],
        ['MB01',0,'PDPC0001, PDPC0002','標準機'],
        ['MBX02 巨無霸',0,'SPORT01','巨無霸'],
        ['MB03',0,'WATER01, COFFEE01',''],
        ['MB04',0,'',''],
        ['MB05',0,'',''],
        ['MBS01左',0,'','迷你機'],['MBS01右',0,'','迷你機'],['MBS03左',0,'','迷你機'],['MBS03右',0,'','迷你機']];
      const ws = XLSX.utils.aoa_to_sheet([...daily, [], ...machines]);
      XLSX.utils.book_append_sheet(wb, ws, '店A');

      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='weekly_single_store_with_items_template.xlsx';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>