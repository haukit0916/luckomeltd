<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>FunFun營運儀表板</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --grid:#233046;
      --line:#22d3ee; --ma:#a78bfa; --line-per:#38bdf8;
      /* 指定長條色：標準=紅、巨無霸=藍、迷你=綠 */
      --bar-standard:#ef4444;  /* red-500 */
      --bar-giant:#38bdf8; /* blue-400 */
      --bar-mini:#22c55e;      /* green-500 */

      --border:rgba(148,163,184,.2); --thead:rgba(255,255,255,.03); --highlight:rgba(255,255,255,.06);
      --toast:#111827cc;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:linear-gradient(180deg,#0b1022 0%, #0f172a 100%); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Helvetica Neue", Arial; }
    header{ padding:16px 16px 0; max-width:1280px; margin:0 auto; }
    h1{ font-size:clamp(18px,4vw,24px); margin:0 0 6px; font-weight:700; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:clamp(12px,2.5vw,14px); margin:0 0 12px; }
    .wrap{ max-width:1280px; margin:0 auto; padding:12px 16px 28px; display:grid; gap:18px; }
    .panel{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .title-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
    .title{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:8px; background:rgba(167,139,250,.08); border:1px solid rgba(167,139,250,.35);
      color:#e9d5ff; padding:6px 10px; border-radius:999px; font-size:12px; }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="number"], input[type="search"], input[type="date"], select{
      appearance:none; border:1px solid var(--border); background:#1f2937; color:#e5e7eb;
      padding:8px 10px; border-radius:10px; font-size:13px; outline:none;
    }
    input[type="file"]{ color:var(--muted); font-size:12px; background:rgba(255,255,255,.03);
      border:1px dashed var(--border); padding:6px 10px; border-radius:10px; }
    .btn{ appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#e5e7eb;
      padding:8px 10px; border-radius:10px; font-size:13px; cursor:pointer; }
    .btn.primary{ background:linear-gradient(180deg, rgba(34,211,238,.25), rgba(34,211,238,.08)); border-color: rgba(34,211,238,.55); }
    .pill{ padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); font-size:12px; color:#cbd5e1; }
    .kpis{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; margin:8px 0; }
    .kpi{ background:rgba(34,211,238,.06); border:1px solid rgba(34,211,238,.35); border-radius:10px; padding:10px; }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted); font-weight:500; }
    .kpi .val{ font-size:18px; font-weight:700; letter-spacing:.3px; margin-top:4px; }
    .chart-wrap{ position:relative; width:100%; aspect-ratio: 16/9; min-height:260px; }
    canvas{ width:100% !important; height:100% !important; }
    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:10px; max-height:360px; background:rgba(0,0,0,.06); }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; font-size:12px; color:#e5e7eb; vertical-align:top; }
    th{ color:#cbd5e1; background:var(--thead); position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.02); }
    tbody tr:hover{ background:var(--highlight); }

    /* Facet grid */
    .facet-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; }
    .facet-card{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid var(--border); border-radius:12px; padding:8px; position:relative; }
    .facet-title{ display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#cbd5e1; margin-bottom:4px; }
    .facet-meta{ color:var(--muted); font-size:11px; }
    .facet-canvas{ width:100%; height:120px; display:block; }
    .facet-pager{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .tooltip{ position:absolute; pointer-events:none; background:rgba(17,24,39,.96); color:#e5e7eb; border:1px solid rgba(148,163,184,.35);
      border-radius:8px; padding:6px 8px; font-size:12px; white-space:nowrap; transform:translate(-50%,-110%); z-index:100; display:none; }
    .toast{ position:fixed; right:12px; top:12px; background:#111827cc; color:#e5e7eb; border:1px solid rgba(148,163,184,.35);
      padding:10px 12px; border-radius:10px; font-size:13px; z-index:9999; opacity:0; transform:translateY(-10px); transition:all .25s ease; }
    .toast.show{ opacity:1; transform:translateY(0); }

    @media (max-width:860px){
      .kpis{ grid-template-columns:1fr; }
      .chart-wrap{ aspect-ratio: 4/3; min-height:240px; }
      .table-wrap{ max-height:300px; }
      input[type="file"]{ width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>FunFun營運儀表板</h1>
  </header>

  <div class="wrap">
    <!-- 匯入/期間/分店 -->
    <section class="panel">
      <div class="title-row">
        <div class="title"><span class="badge">上載 XLSX / 期間 / 分店</span></div>
        <div class="controls">
          <input id="uploadXlsx" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <button id="downloadTemplate" class="btn primary">下載模板</button>
          <label>分店</label>
          <select id="storeSelect"><option>（尚無數據）</option></select>
          <label>期間</label>
          <button class="btn" id="quick7">近7天</button>
          <button class="btn" id="quick14">近14天</button>
          <button class="btn" id="quick30">近30天</button>
          <input type="date" id="fromDate" /> 至 <input type="date" id="toDate" />
          <button class="btn" id="applyRange">套用</button>
        </div>
      </div>
    </section>

    <!-- 圖1 -->
    <section class="panel">
      <div class="title-row">
        <div class="title"><span class="badge">店×日：總營收HKD / 平均機台營收HKD</span></div>
        <div class="controls">
          <button class="btn" id="toggleMA">顯示/隱藏 7日MA</button>
          <button class="btn" id="resetLineZoom">重置縮放</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><h3>總營收（期間）</h3><div class="val" id="kpiLineTotal">—</div></div>
        <div class="kpi"><h3>日均營收</h3><div class="val" id="kpiLineAvg">—</div></div>
        <div class="kpi"><h3>機台數量</h3><div class="val" id="kpiMachines">—</div></div>
        <div class="kpi"><h3>期間平均機台營收</h3><div class="val" id="kpiPerMachineAvg">—</div></div>
      </div>

      <div class="chart-wrap" style="position:relative;">
        <canvas id="lineChart"></canvas>
        <div id="lineTooltip" class="tooltip"></div>
      </div>

      <div class="table-wrap">
        <table id="lineTable">
          <thead><tr><th>日期</th><th>總營收(HKD)</th><th>機台數量</th><th>平均機台營收(HKD)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 圖2：店×機（長條色依類別：紅/黃/綠） -->
    <section class="panel">
      <div class="title-row">
        <div class="title"><span class="badge">店×機：投幣量（HKD）＋貨品資訊</span></div>
        <div class="controls">
          - 類別
          <select id="filterSeries">
            <option value="ALL">全部</option>
            <option value="標準機">標準機</option>
            <option value="巨無霸">巨無霸</option>
            <option value="迷你機">迷你機</option>
          </select>
          - 顯示
          <select id="passFilter">
            <option value="ALL">全部</option>
            <option value="PASS">合格</option>
            <option value="FAIL">不合格</option>
          </select>
          - 排序
          <select id="sortBy">
            <option value="name-asc" selected>機器名稱：A→Z（預設）</option>
            <option value="name-desc">機器名稱：Z→A</option>
            <option value="total-desc">投幣量：高→低</option>
            <option value="total-asc">投幣量：低→高</option>
            <option value="goods-asc">上架貨品：A→Z</option>
            <option value="goods-desc">上架貨品：Z→A</option>
            <option value="price-asc">單價：低→高</option>
            <option value="price-desc">單價：高→低</option>
            <option value="listed-asc">上架日期：早→晚</option>
            <option value="listed-desc">上架日期：晚→早</option>
          </select>
          - 顯示數量
          <select id="topn">
            <option>全部</option><option>5</option><option>10</option><option>20</option><option>50</option>
          </select>
          <input id="searchBox" type="search" placeholder="搜尋機器名稱..." />
          - 單價篩選
          <label>下限(含) <input id="priceMin" type="number" inputmode="decimal" placeholder="例：20" style="width:90px"></label>
          <label>上限(含) <input id="priceMax" type="number" inputmode="decimal" placeholder="例：50" style="width:90px"></label>
          <span class="pill" id="autoThresholdPill">合格線：—</span>
          <button id="resetBar" class="btn">重置</button>
        </div>
      </div>

      <div class="kpis" id="barKpis" style="grid-template-columns:repeat(3,minmax(0,1fr));">
        <div class="kpi"><h3>合格/未達</h3><div class="val" id="kpiBarPass">—</div><div class="delta" id="kpiBarPassSub">—</div></div>
        <div class="kpi"><h3>顯示筆數</h3><div class="val" id="kpiBarCount">—</div><div class="delta">符合篩選與搜尋</div></div>
        <div class="kpi"><h3>目前分店</h3><div class="val" id="kpiStoreName">—</div><div class="delta">期間同步</div></div>
      </div>

      <div class="chart-wrap" style="position:relative;">
        <canvas id="barChart"></canvas>
        <div id="barTooltip" class="tooltip"></div>
      </div>

      <div class="table-wrap">
        <table id="dataTable">
          <thead><tr><th>機器名稱</th><th>類別</th><th>投幣量(HKD)</th><th>上架貨品（名稱）</th><th>單價</th><th>上架日期</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 圖3 -->
    <section class="panel">
      <div class="title-row">
        <div class="title"><span class="badge">機台×日走勢</span></div>
        <div class="controls">
          <label>模式</label>
          <select id="trendMode">
            <option value="FACET">分面迷你折線</option>
            <option value="MULTI">多線折線</option>
          </select>
          <label>顯示</label>
          <select id="trendY">
            <option value="HKD">HKD</option>
            <option value="GOODS">上架貨品名稱</option>
          </select>
          <label>類別</label>
          <select id="trendCat">
            <option value="ALL">全部</option>
            <option value="標準機">標準機</option>
            <option value="巨無霸">巨無霸</option>
            <option value="迷你機">迷你機</option>
          </select>
          <input id="trendSearch" type="search" placeholder="搜尋機器名稱..." />
          <label>排序</label>
          <select id="trendSort">
            <option value="name-asc" selected>名稱 A→Z（預設）</option>
            <option value="name-desc">名稱 Z→A</option>
            <option value="cat-asc">類別 A→Z</option>
            <option value="sum-desc">期間總HKD 高→低</option>
            <option value="sum-asc">期間總HKD 低→高</option>
            <option value="avg-desc">期間平均HKD 高→低</option>
            <option value="avg-asc">期間平均HKD 低→高</option>
            <option value="max-desc">最大單日HKD 高→低</option>
            <option value="max-asc">最大單日HKD 低→高</option>
          </select>
          <label>TopN（多線）</label>
          <select id="trendTopN">
            <option value="10" selected>10</option>
            <option>20</option><option>50</option><option value="ALL">全部</option>
          </select>
          <label id="facetControls" style="display:flex; align-items:center; gap:8px;">
            每頁
            <select id="facetPageSize">
              <option selected>12</option><option>24</option><option>36</option><option>48</option>
            </select>
            <span class="facet-pager">
              <button class="btn" id="facetPrev">上一頁</button>
              <span class="pill" id="facetPageInfo">—</span>
              <button class="btn" id="facetNext">下一頁</button>
            </span>
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="facetUnifiedY" /> 統一Y軸
            </label>
          </label>
        </div>
      </div>

      <div class="chart-wrap" id="multiWrap" style="display:none; position:relative;">
        <canvas id="trendChart"></canvas>
        <div id="trendTooltip" class="tooltip"></div>
      </div>

      <div id="facetWrap" class="facet-grid"></div>

      <div class="table-wrap">
        <table id="trendTable">
          <thead><tr><th>日期</th><th>機器名稱</th><th>HKD</th><th>上架貨品</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- SheetJS -->
  <script>
    const loadXLSX = (()=>{ let p=null; return ()=>{ if(p) return p; p=new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=()=>res(window.XLSX); s.onerror=()=>rej(new Error('無法載入 XLSX')); document.head.appendChild(s); }); return p; }; })();
  </script>

  <script>
    // 工具
    const HKD_RATE=5;
    const fmt=n=>Number(n||0).toLocaleString('zh-Hant-TW');
    const norm=s=>String(s||'').trim();
    function parseExcelDate(v){
      if(typeof v==='number' && isFinite(v)){ const d=new Date(Date.UTC(1899,11,30)+Math.round(v)*86400000); return d.toISOString().slice(0,10); }
      if(v instanceof Date && !isNaN(v.valueOf())){ const d=v; return new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())).toISOString().slice(0,10); }
      const s=String(v||'').trim(); const clean=s.replace(/[年\.]/g,'/').replace(/[月]/g,'/').replace(/[日]/g,'').replace(/^\'+/,'').replace(/\s+/g,'');
      const m=clean.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/); if(m){ const y=+m[1], mo=Math.min(Math.max(+m[2],1),12)-1, d=Math.min(Math.max(+m[3],1),31); const z=new Date(Date.UTC(y,mo,d)); return z.toISOString().slice(0,10); }
      const t=Date.parse(clean); if(!isNaN(t)){ const d=new Date(t); return new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())).toISOString().slice(0,10); }
      return null;
    }
    function formatOutDate(iso){ if(!iso) return ''; const m=String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/); return m?`${m[1]}/${m[2]}/${m[3]}`:String(iso); }
    const toast=(msg)=>{ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(el._t); el._t=setTimeout(()=> el.classList.remove('show'), 2200); };

    // 狀態
    const stores=new Map();           // store -> {dates:Set, byDate, byMachine}
    const storeMachines=new Map();    // store -> machines
    let itemsDict=new Map();          // code -> name
    let machineMeta=new Map();        // machine_name -> {category, goods, price, listed}
    let currentStore=null, range={from:null,to:null};
    let thresholdHKD=null;            // 合格線（機均×日數）

    // 解析 XLSX
    async function parseXlsx(file){
      const XLSX=await loadXLSX();
      const wb = XLSX.read(await file.arrayBuffer(),{type:'array'});

      // Items
      const itemsName=wb.SheetNames.find(n=>/^items$/i.test(n)||/物資/i.test(n));
      if(itemsName){
        const arr=XLSX.utils.sheet_to_json(wb.Sheets[itemsName],{header:1,raw:true,defval:''});
        const h=arr[0]?.map(x=>norm(x).toLowerCase())||[];
        const ic=h.findIndex(x=>['code','編號','物資編號','stockno','stock no','id'].includes(x));
        const iname=h.findIndex(x=>['name','品名','名稱','item name','物資名稱'].includes(x));
        if(ic>-1 && iname>-1) itemsDict=new Map(arr.slice(1).map(r=>[norm(r[ic]), norm(r[iname])]).filter(([a,b])=>a&&b));
      }

      // MachinesMeta
      const metaName=wb.SheetNames.find(n=>/^machinesmeta$/i.test(n) || /meta/i.test(n));
      machineMeta.clear();
      if(metaName){
        const arr=XLSX.utils.sheet_to_json(wb.Sheets[metaName],{header:1,raw:true,defval:''});
        const h=arr[0]?.map(x=>norm(x).toLowerCase())||[];
        const im=h.findIndex(x=>['machine_name','機台號','機器','name','machine'].includes(x));
        const ic=h.findIndex(x=>['category','分類','系列','機型'].includes(x));
        const ig=h.findIndex(x=>['goods','上架貨品','商品','品名','items'].includes(x));
        const ip=h.findIndex(x=>['price','單價','售價'].includes(x));
        const il=h.findIndex(x=>['listed','上架日期','上架','list_date','on_shelf'].includes(x));
        arr.slice(1).forEach(r=>{
          const key=norm(r[im]); if(!key) return;
          const listedStd=parseExcelDate(r[il])||'';
          // 類別收斂至三種
          const cat = normalizeCategory(norm(r[ic]||''));
          machineMeta.set(key,{category:cat, goods:norm(r[ig]||''), price:norm(r[ip]||''), listed:listedStd});
        });
      }

      // StoresMachines
      storeMachines.clear();
      const smName=wb.SheetNames.find(n=>/^storesmachines$/i.test(n));
      if(smName){
        const arr=XLSX.utils.sheet_to_json(wb.Sheets[smName],{header:1,raw:true,defval:''});
        const h=arr[0]?.map(x=>norm(x).toLowerCase())||[];
        const is=h.findIndex(x=>['store','門市','門市名稱','店','分店'].includes(x));
        const im=h.findIndex(x=>['machines','機台數量','機器數','台數'].includes(x));
        if(is>-1 && im>-1){
          arr.slice(1).forEach(r=>{
            const st=norm(r[is]); const mv=Number(String(r[im]).replace(/[^\d.\-]/g,''))||0;
            if(st) storeMachines.set(st,mv);
          });
        }
      }

      // RawLog
      const rawName=wb.SheetNames.find(n=>/^rawlog$/i.test(n))||wb.SheetNames[0];
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[rawName],{header:1,raw:true,defval:''});
      const header=rows[0]?.map(x=>norm(x).toLowerCase())||[];
      const idx={
        date: header.findIndex(h=> ['統計日期','日期','date','统计日期'].includes(h)),
        machine: header.findIndex(h=> ['機台號','機台編號','機器','name','machine','機台'].includes(h)),
        store: header.findIndex(h=> ['門市名稱','門市','店','分店','store'].includes(h)),
        coins: header.findIndex(h=> ['線下投幣','投幣量','coins','amount'].includes(h))
      };
      if(idx.date<0||idx.machine<0||idx.store<0||idx.coins<0) throw new Error('RawLog 缺少必要欄（統計日期/機台號/門市名稱/線下投幣）');

      const recs=[];
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; if(!r || r.every(c=>norm(c)==='')) continue;
        const d=parseExcelDate(r[idx.date]); const m=norm(r[idx.machine]); const s=norm(r[idx.store]);
        const c=Number(String(r[idx.coins]).replace(/[^\d.\-]/g,''))||0;
        if(!d||!m||!s) continue;
        recs.push({date:d, machine:m, store:s, hkd:c*HKD_RATE});
      }
      return recs;
    }

    // 類別三種
    function normalizeCategory(raw){
      const r = norm(raw);
      if(/巨無霸|giant|jumbo|mbx/i.test(r)) return '巨無霸';
      if(/迷你|mini|mbs/i.test(r)) return '迷你機';
      return '標準機';
    }
    function inferCategory(name, raw){
      if(raw) return normalizeCategory(raw);
      const n = String(name||'');
      if(/巨無霸|MBX/i.test(n)) return '巨無霸';
      if(/迷你|MBS/i.test(n)) return '迷你機';
      return '標準機';
    }
    function goodsToNames(goods){
      const s=norm(goods); if(!s) return '';
      const parts=s.replace(/[\n;]/g, ',').split(',').map(x=>norm(x)).filter(Boolean);
      const names=parts.map(x=>itemsDict.get(x)||x);
      return Array.from(new Set(names)).join(', ');
    }
    const toPriceNum = v => Number(String(v??'').replace(/[^\d.\-]/g,'')) || 0;

    // 聚合
    function ingest(records){
      stores.clear();
      for(const {date,machine,store,hkd} of records){
        if(!stores.has(store)) stores.set(store,{dates:new Set(), byDate:{}, byMachine:{}});
        const S=stores.get(store);
        S.dates.add(date);
        if(!S.byDate[date]) S.byDate[date]={sumHKD:0,machineSet:new Set()};
        S.byDate[date].sumHKD+=hkd; S.byDate[date].machineSet.add(machine);
        if(!S.byMachine[machine]) S.byMachine[machine]={sumHKD:0, byDate:{}};
        S.byMachine[machine].sumHKD+=hkd; S.byMachine[machine].byDate[date]=(S.byMachine[machine].byDate[date]||0)+hkd;
      }
      const all=[]; for(const [,S] of stores) all.push(...Array.from(S.dates)); if(all.length){ all.sort(); range.from=all[0]; range.to=all[all.length-1]; }
      const sel=document.getElementById('storeSelect'); const cur=sel.value; sel.innerHTML='';
      Array.from(stores.keys()).sort((a,b)=>a.localeCompare(b,'zh-Hant')).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
      currentStore = stores.has(cur)?cur : (stores.size?[...stores.keys()][0]:null);
      if(currentStore) sel.value=currentStore;
      document.getElementById('fromDate').value=range.from||''; document.getElementById('toDate').value=range.to||'';
      renderAll();
    }

    // Tooltip
    function showTip(id,html,x,y){ const el=document.getElementById(id); el.innerHTML=html; el.style.left=x+'px'; el.style.top=y+'px'; el.style.display='block'; }
    function hideTip(id){ document.getElementById(id).style.display='none'; }

    // 圖表類（折線）
    class DualLineChart{
      constructor(c){ this.c=c; this.ctx=c.getContext('2d'); this.p={l:62,r:16,t:22,b:46}; this.points=[]; this.showMA=true; new ResizeObserver(()=>this.draw()).observe(c); this._bind(); }
      setData(pts){ this.points=pts; const ys=[...pts.map(p=>p.yTotal),...pts.map(p=>p.yPer)]; const yMin=Math.min(0,...ys), yMax=Math.max(1,...ys), pad=Math.max(1,(yMax-yMin)*0.1);
        this.yMin=Math.max(0,Math.floor(yMin-pad)); this.yMax=Math.ceil(yMax+pad); this.xMin=Math.min(...pts.map(p=>p.x)||[0]); this.xMax=Math.max(...pts.map(p=>p.x)||[1]); this.draw(); }
      reset(){ this.draw(); }
      _x(x){ const r=this.c.getBoundingClientRect(), w=r.width-this.p.l-this.p.r; return this.p.l+(x-this.xMin)/(this.xMax-this.xMin||1)*w; }
      _y(y){ const r=this.c.getBoundingClientRect(), h=r.height-this.p.t-this.p.b; return this.p.t + (1-(y-this.yMin)/(this.yMax-this.yMin||1))*h; }
      _ticks(min,max,c=5){ const span=max-min, raw=span/c, pow=10**Math.floor(Math.log10(raw||1)), m=[1,2,2.5,5,10]; let step=m[0]*pow; for(const v of m){ if(raw<=v*pow){ step=v*pow; break; } } const s=Math.ceil(min/step)*step, out=[]; for(let v=s; v<=max; v+=step) out.push(v); return out; }
      _bind(){
        this.c.addEventListener('mousemove', (e)=>{
          if(!this.points.length){ hideTip('lineTooltip'); return; }
          const rect=this.c.getBoundingClientRect(); const mx=e.clientX-rect.left;
          let bestIdx=0, bestDist=Infinity;
          for(let i=0;i<this.points.length;i++){ const dx=Math.abs(this._x(this.points[i].x)-mx); if(dx<bestDist){bestDist=dx; bestIdx=i;} }
          const p=this.points[bestIdx], d=new Date(p.x);
          const html=`${formatOutDate(d.toISOString().slice(0,10))}<br/>總 HKD ${fmt(Math.round(p.yTotal))}<br/>機均 HKD ${fmt(Math.round(p.yPer))}<br/>機台數 ${p.cnt}`;
          showTip('lineTooltip', html, e.clientX, e.clientY-8); this._hoverIndex=bestIdx; this.draw();
        });
        this.c.addEventListener('mouseleave', ()=>{ hideTip('lineTooltip'); this._hoverIndex=null; this.draw(); });
      }
      draw(){
        const {ctx}=this; const dpr=window.devicePixelRatio||1, r=this.c.getBoundingClientRect(); this.c.width=Math.round(r.width*dpr); this.c.height=Math.round(r.height*dpr); ctx.scale(dpr,dpr);
        ctx.clearRect(0,0,r.width,r.height); const {l,r:rr,t,b}=this.p; const grid='#233046';
        ctx.strokeStyle=grid; ctx.beginPath(); for(const y of this._ticks(this.yMin,this.yMax,5)){ const py=this._y(y); ctx.moveTo(l,py); ctx.lineTo(r.width-rr,py);} ctx.stroke();
        ctx.fillStyle='#94a3b8'; ctx.font='12px ui-sans-serif, system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
        for(const y of this._ticks(this.yMin,this.yMax,5)){ ctx.fillText(fmt(Math.round(y)), l-8, this._y(y)); }
        ctx.textAlign='center'; ctx.textBaseline='top';
        for(const p of this.points){ const d=new Date(p.x); ctx.fillText(`${d.getUTCMonth()+1}/${d.getUTCDate()}`, this._x(p.x), r.height-b+6); }
        ctx.strokeStyle='#22d3ee'; ctx.lineWidth=2; ctx.beginPath(); let s=false;
        for(const p of this.points){ const x=this._x(p.x), y=this._y(p.yTotal); if(!s){ctx.moveTo(x,y); s=true;} else ctx.lineTo(x,y);} ctx.stroke();
        ctx.strokeStyle='#f59e0b'; ctx.lineWidth=2; ctx.setLineDash([4,2]); ctx.beginPath(); s=false;
        for(const p of this.points){ const x=this._x(p.x), y=this._y(p.yPer); if(!s){ctx.moveTo(x,y); s=true;} else ctx.lineTo(x,y);} ctx.stroke(); ctx.setLineDash([]);
        if(this.showMA){ const base=this.points, k=7, ma=[]; for(let i=0;i<base.length;i++){ const a=Math.max(0,i-k+1); const part=base.slice(a,i+1); const avg=part.reduce((s,p)=>s+p.yTotal,0)/part.length; ma.push({x:base[i].x,y:avg}); }
          ctx.strokeStyle='#a78bfa'; ctx.setLineDash([6,6]); ctx.lineWidth=1.6; ctx.beginPath(); s=false;
          for(const p of ma){ const x=this._x(p.x), y=this._y(p.y); if(!s){ctx.moveTo(x,y); s=true;} else ctx.lineTo(x,y);} ctx.stroke(); ctx.setLineDash([]); }
        if(this._hoverIndex!=null){ const p=this.points[this._hoverIndex]; const x=this._x(p.x); ctx.strokeStyle='rgba(255,255,255,.3)'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(x,t); ctx.lineTo(x,r.height-b); ctx.stroke(); ctx.setLineDash([]); }
      }
    }

    // 長條圖（顏色：標準=紅、巨無霸=黃、迷你=綠）
    class BarChart{
      constructor(c){ this.c=c; this.ctx=c.getContext('2d'); this.p={l:70,r:20,t:18,b:54}; this.data=[]; this.maxY=1; this.threshold=null; new ResizeObserver(()=>this.draw()).observe(c);
        this._bind();
      }
      setData(d){ this.data=Array.isArray(d)?d.slice():[]; this.maxY=Math.max(1,...this.data.map(x=>x.total||0))*1.1; this.draw(); }
      setThreshold(v){ this.threshold=(v==null||isNaN(v))?null:Number(v); this.draw(); }
      _y(v){ const r=this.c.getBoundingClientRect(), h=r.height-this.p.t-this.p.b; return this.p.t+(1-v/this.maxY)*h; }
      _ticks(min,max,c=5){ const span=max-min, raw=span/c, pow=10**Math.floor(Math.log10(raw||1)), a=[1,2,2.5,5,10]; let step=a[0]*pow; for(const m of a){ if(raw<=m*pow){ step=m*pow; break; } } const t=[]; for(let v=0; v<=max; v+=step) t.push(v); return t; }
      _bind(){
        this.c.addEventListener('mousemove', (e)=>{
          const rect=this.c.getBoundingClientRect(); const {l,r,t,b}=this.p; const plotW=rect.width-l-r; const n=this.data.length; if(!n){ hideTip('barTooltip'); return; }
          const cellW=plotW/n; const idx=Math.floor((e.clientX-rect.left-l)/cellW); if(idx<0 || idx>=n){ hideTip('barTooltip'); this._hover=-1; this.draw(); return; }
          const d=this.data[idx]; this._hover=idx; this.draw();
          const html=`${d.name}<br/>HKD ${fmt(Math.round(d.total||0))}<br/>${d.category||''}${d.goods?'<br/>'+d.goods:''}${d.price?'<br/>單價 '+d.price:''}${d.listed?'<br/>上架 '+formatOutDate(d.listed):''}`;
          showTip('barTooltip', html, e.clientX, e.clientY-10);
        });
        this.c.addEventListener('mouseleave', ()=>{ this._hover=-1; this.draw(); hideTip('barTooltip'); });
      }
      draw(){
        const ctx=this.ctx, dpr=window.devicePixelRatio||1, r=this.c.getBoundingClientRect(); this.c.width=Math.round(r.width*dpr); this.c.height=Math.round(r.height*dpr); ctx.scale(dpr,dpr); ctx.clearRect(0,0,r.width,r.height);
        const {l,r:rr,t,b}=this.p, plotW=r.width-l-rr, plotH=r.height-t-b;
        ctx.strokeStyle='#233046'; ctx.beginPath(); for(const y of this._ticks(0,this.maxY,5)){ const py=this._y(y); ctx.moveTo(l,py); ctx.lineTo(r.width-rr,py);} ctx.stroke();
        ctx.fillStyle='#94a3b8'; ctx.font='12px ui-sans-serif, system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
        for(const y of this._ticks(0,this.maxY,5)){ ctx.fillText(fmt(Math.round(y)), l-8, this._y(y)); }
        if(!this.data.length){ ctx.fillStyle='#e5e7eb'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('無資料', r.width/2, r.height/2); return; }
        if(this.threshold!=null){ const y=this._y(this.threshold); ctx.save(); ctx.strokeStyle='rgba(239,68,68,.9)'; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(l,y); ctx.lineTo(r.width-rr,y); ctx.stroke(); ctx.restore(); }
        const n=this.data.length, barW=(plotW/n)*0.78, gap=(plotW/n)*0.22; let x=l+gap/2;
        const colorOf=cat=> cat==='巨無霸'?getComputedStyle(document.documentElement).getPropertyValue('--bar-giant').trim() :
                               cat==='迷你機'?getComputedStyle(document.documentElement).getPropertyValue('--bar-mini').trim() :
                               getComputedStyle(document.documentElement).getPropertyValue('--bar-standard').trim();
        for(let i=0;i<n;i++){
          const d=this.data[i]; const bh=plotH*(Number(d.total||0)/this.maxY), y=t+(plotH-bh);
          ctx.fillStyle=colorOf(d.category); roundRect(ctx,x,y,barW,bh,6); ctx.fill();
          if(i===this._hover){ ctx.strokeStyle='rgba(255,255,255,.7)'; ctx.lineWidth=1; roundRect(ctx,x,y,barW,bh,6); ctx.stroke(); }
          x+=barW+gap;
        }
        ctx.fillStyle='#94a3b8'; ctx.textAlign=n>18?'right':'center'; ctx.textBaseline='top'; x=l+gap/2;
        for(let i=0;i<n;i++){ const d=this.data[i]; const lx=x+barW/2, ly=r.height-b+6;
          if(n>18){ ctx.save(); ctx.translate(lx,ly); ctx.rotate(-Math.PI/4); ctx.fillText(String(d.name),0,0); ctx.restore(); } else ctx.fillText(String(d.name),lx,ly);
          x+=barW+gap;
        }
      }
    }
    function roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

    // 多線
    class MultiLine{
      constructor(c){ this.c=c; this.ctx=c.getContext('2d'); this.p={l:62,r:16,t:22,b:46}; this.series=[]; new ResizeObserver(()=>this.draw()).observe(c); this._bind(); }
      setData(series){ this.series=series; const ys=[]; series.forEach(s=>s.points.forEach(p=>ys.push(p.y))); const yMin=Math.min(0,...ys,0), yMax=Math.max(1,...ys,1), pad=Math.max(1,(yMax-yMin)*0.1);
        this.yMin=Math.max(0,Math.floor(yMin-pad)); this.yMax=Math.ceil(yMax+pad); const allX=series.flatMap(s=>s.points.map(p=>p.x)); this.xMin=Math.min(...allX)||0; this.xMax=Math.max(...allX)||1; this.draw(); }
      _x(x){ const r=this.c.getBoundingClientRect(), w=r.width-this.p.l-this.p.r; return this.p.l+(x-this.xMin)/(this.xMax-this.xMin||1)*w; }
      _y(y){ const r=this.c.getBoundingClientRect(), h=r.height-this.p.t-this.p.b; return this.p.t+(1-(y-this.yMin)/(this.yMax-this.yMin||1))*h; }
      _ticks(min,max,c=5){ const span=max-min; const raw=span/c; const pow=10**Math.floor(Math.log10(raw||1)); const mult=[1,2,2.5,5,10]; let step=mult[0]*pow; for(const m of mult){ if(raw<=m*pow){ step=m*pow; break; } } const start=Math.ceil(min/step)*step, out=[]; for(let v=start; v<=max; v+=step) out.push(v); return out; }
      _bind(){
        this.c.addEventListener('mousemove', (e)=>{
          if(!this.series.length){ hideTip('trendTooltip'); return; }
          const rect=this.c.getBoundingClientRect(); const mx=e.clientX-rect.left;
          const base=this.series[0]?.points||[]; if(!base.length){ hideTip('trendTooltip'); return; }
          let bestIdx=0, bestDist=Infinity;
          for(let i=0;i<base.length;i++){ const dx=Math.abs(this._x(base[i].x)-mx); if(dx<bestDist){bestDist=dx; bestIdx=i;} }
          const dateStr = new Date(base[bestIdx].x).toISOString().slice(0,10);
          const vals=this.series.map(s=>({name:s.name, v:s.points[bestIdx]?.y??0, goods:s.goods}));
          vals.sort((a,b)=>b.v-a.v);
          const html = `${formatOutDate(dateStr)}<br/>` + vals.slice(0,12).map(x=>`${x.name}: ${x.v.toFixed(2)}（${x.goods||'—'}）`).join('<br/>') + (vals.length>12?'<br/>…':'');
          showTip('trendTooltip', html, e.clientX, e.clientY-10); this._hoverX=this._x(base[bestIdx].x); this.draw();
        });
        this.c.addEventListener('mouseleave', ()=>{ hideTip('trendTooltip'); this._hoverX=null; this.draw(); });
      }
      draw(){
        const ctx=this.ctx, dpr=window.devicePixelRatio||1, r=this.c.getBoundingClientRect(); this.c.width=Math.round(r.width*dpr); this.c.height=Math.round(r.height*dpr); ctx.scale(dpr,dpr); ctx.clearRect(0,0,r.width,r.height);
        const {l,r:rr,t,b}=this.p; const grid='#233046';
        ctx.strokeStyle=grid; ctx.beginPath(); for(const y of this._ticks(this.yMin,this.yMax,5)){ const py=this._y(y); ctx.moveTo(l,py); ctx.lineTo(r.width-rr,py);} ctx.stroke();
        ctx.fillStyle='#94a3b8'; ctx.font='12px ui-sans-serif, system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
        for(const y of this._ticks(this.yMin,this.yMax,5)){ ctx.fillText(fmt(Math.round(y)), l-8, this._y(y)); }
        ctx.textAlign='center'; ctx.textBaseline='top';
        const base=this.series[0]?.points||[]; for(const p of base){ const d=new Date(p.x); ctx.fillText(`${d.getUTCMonth()+1}/${d.getUTCDate()}`, this._x(p.x), r.height-b+6); }
        const palette=['#22d3ee','#f59e0b','#22c55e','#a78bfa','#fb7185','#f97316','#10b981','#06b6d4','#ef4444','#eab308','#14b8a6','#8b5cf6'];
        this.series.forEach((s,i)=>{ ctx.strokeStyle=palette[i%palette.length]; ctx.lineWidth=2; ctx.beginPath(); let st=false; for(const p of s.points){ const x=this._x(p.x), y=this._y(p.y); if(!st){ctx.moveTo(x,y); st=true;} else ctx.lineTo(x,y);} ctx.stroke(); });
        if(this._hoverX!=null){ ctx.strokeStyle='rgba(255,255,255,.3)'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(this._hoverX,t); ctx.lineTo(this._hoverX,r.height-b); ctx.stroke(); ctx.setLineDash([]); }
      }
    }

    // 渲染
    const lineChart=new DualLineChart(document.getElementById('lineChart'));
    const barChart=new BarChart(document.getElementById('barChart'));
    const trendChart=new MultiLine(document.getElementById('trendChart'));

    function getMachinesForDate(storeName,date,S){
      if(storeMachines.has(storeName)) return storeMachines.get(storeName);
      return S.byDate[date]?.machineSet?.size||0;
    }
    function recomputeThreshold(points){
      const days = points.length;
      const perAvg = points.length? points.reduce((s,p)=>s+p.yPer,0)/points.length : 0;
      return perAvg * days;
    }

    function renderAll(){
      if(!currentStore || !stores.has(currentStore)) return;
      const S=stores.get(currentStore);
      const dates=Array.from(S.dates).filter(d=>d>=range.from && d<=range.to).sort();

      const points=dates.map(d=>{
        const sum=S.byDate[d]?.sumHKD||0;
        const cnt = getMachinesForDate(currentStore,d,S);
        const per=cnt>0?sum/cnt:0;
        return {x:Date.parse(d+'T00:00:00Z'), yTotal:sum, yPer:per, cnt, date:d};
      });
      lineChart.setData(points);

      const sumTotal=points.reduce((s,p)=>s+p.yTotal,0), avgDaily=points.length?sumTotal/points.length:0;
      const lastCnt=[...points].reverse().find(p=>p.cnt>0)?.cnt||0;
      const perAvg=points.length?points.reduce((s,p)=>s+p.yPer,0)/points.length:0;
      document.getElementById('kpiLineTotal').textContent=fmt(Math.round(sumTotal));
      document.getElementById('kpiLineAvg').textContent=fmt(Math.round(avgDaily));
      document.getElementById('kpiMachines').textContent=String(lastCnt||'—');
      document.getElementById('kpiPerMachineAvg').textContent=fmt(Math.round(perAvg));

      thresholdHKD = recomputeThreshold(points);
      document.getElementById('autoThresholdPill').textContent = `合格線（機均×日數）：${fmt(Math.round(thresholdHKD||0))}`;

      const tb=document.querySelector('#lineTable tbody'); tb.innerHTML='';
      points.forEach(p=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${formatOutDate(p.date)}</td><td>${fmt(Math.round(p.yTotal))}</td><td>${p.cnt||''}</td><td>${fmt(Math.round(p.yPer))}</td>`;
        tb.appendChild(tr);
      });

      const arr=Object.entries(S.byMachine).map(([name,obj])=>{
        let total=0; for(const d of dates) total+=obj.byDate[d]||0;
        const meta=machineMeta.get(name)||{};
        return { name, total,
          category: inferCategory(name, meta.category),
          goods: goodsToNames(meta.goods||''),
          price: meta.price||'',
          listed: meta.listed||'' };
      });
      renderBar(arr);
      renderTrend();
    }

    function renderBar(arr){
      const filterSeries=document.getElementById('filterSeries').value;
      const passFilter=document.getElementById('passFilter').value;
      const sortBy=document.getElementById('sortBy').value;
      const topn=document.getElementById('topn').value;
      const q=(document.getElementById('searchBox').value||'').trim().toLowerCase();
      const priceMin = document.getElementById('priceMin').value;
      const priceMax = document.getElementById('priceMax').value;
      const thr=thresholdHKD;

      let data = (Array.isArray(arr)? arr.slice(): []).map(d=>({ ...d, priceNum: toPriceNum(d.price) }));

      if(filterSeries!=='ALL') data = data.filter(d=>d.category===filterSeries);
      if(q) data = data.filter(d=> d.name.toLowerCase().includes(q) );
      if(priceMin !== '') data = data.filter(d=> d.priceNum >= Number(priceMin));
      if(priceMax !== '') data = data.filter(d=> d.priceNum <= Number(priceMax));

      if(passFilter!=='ALL' && typeof thr==='number' && !isNaN(thr)){
        data = data.filter(d=> passFilter==='PASS'? (Number(d.total||0)>=thr) : (Number(d.total||0)<thr) );
      }

      const asDate=s=>Date.parse(s||'')||0;
      switch(sortBy){
        case 'name-asc': data.sort((a,b)=>String(a.name).localeCompare(String(b.name),'zh-Hant')); break;
        case 'name-desc': data.sort((a,b)=>String(b.name).localeCompare(String(a.name),'zh-Hant')); break;
        case 'total-desc': data.sort((a,b)=>Number(b.total||0)-Number(a.total||0)); break;
        case 'total-asc': data.sort((a,b)=>Number(a.total||0)-Number(b.total||0)); break;
        case 'goods-asc': data.sort((a,b)=>String(a.goods||'').localeCompare(String(b.goods||''),'zh-Hant')); break;
        case 'goods-desc': data.sort((a,b)=>String(b.goods||'').localeCompare(String(a.goods||''),'zh-Hant')); break;
        case 'price-asc': data.sort((a,b)=>a.priceNum-b.priceNum); break;
        case 'price-desc': data.sort((a,b)=>b.priceNum-a.priceNum); break;
        case 'listed-asc': data.sort((a,b)=>asDate(a.listed)-asDate(b.listed)); break;
        case 'listed-desc': data.sort((a,b)=>asDate(b.listed)-asDate(a.listed)); break;
      }
      if(topn!=='全部'){ const n=parseInt(topn,10); if(!isNaN(n)) data=data.slice(0,n); }

      document.getElementById('kpiBarCount').textContent=String(data.length);
      if(typeof thr!=='number' || isNaN(thr)){
        document.getElementById('kpiBarPass').textContent='—';
        document.getElementById('kpiBarPassSub').textContent='—';
      } else {
        const pass = data.filter(d=>Number(d.total||0)>=thr).length;
        const fail = data.length - pass;
        const rate = data.length? Math.round(pass/data.length*100) : 0;
        document.getElementById('kpiBarPass').textContent=`${pass} / ${data.length}`;
        document.getElementById('kpiBarPassSub').textContent=`合格率 ${rate}%（未達 ${fail}）`;
      }
      document.getElementById('kpiStoreName').textContent=currentStore||'—';

      const tbody=document.querySelector('#dataTable tbody'); tbody.innerHTML='';
      data.forEach(d=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${d.name}</td><td>${d.category}</td><td>${fmt(Math.round(Number(d.total||0)))}</td><td>${d.goods||'—'}</td><td>${d.price||'—'}</td><td>${formatOutDate(d.listed)||'—'}</td>`;
        tbody.appendChild(tr);
      });

      barChart.setData(data);
      barChart.setThreshold(thr);
    }

    // 走勢（分面/多線）
    let facetState={ page:1, pageSize:12, unifiedY:false };

    function getTrendFilteredMachines(){
      if(!currentStore || !stores.has(currentStore)) return [];
      const S=stores.get(currentStore);
      const dates=Array.from(S.dates).filter(d=>d>=range.from && d<=range.to).sort();

      let list = Object.entries(S.byMachine).map(([name,obj])=>{
        let sum=0, maxD=0;
        for(const d of dates){ const v=obj.byDate[d]||0; sum+=v; maxD=Math.max(maxD,v); }
        const avg = dates.length? sum/dates.length : 0;
        const meta=machineMeta.get(name)||{};
        const cat=inferCategory(name, meta.category);
        return {name, category:cat, sum, avg, maxD, goods: goodsToNames(meta.goods||'')};
      });

      const catSel=document.getElementById('trendCat').value;
      const q=(document.getElementById('trendSearch').value||'').trim().toLowerCase();
      if(catSel!=='ALL') list=list.filter(x=>x.category===catSel);
      if(q) list=list.filter(x=> x.name.toLowerCase().includes(q) );

      const sortSel=document.getElementById('trendSort').value;
      switch(sortSel){
        case 'name-asc': list.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')); break;
        case 'name-desc': list.sort((a,b)=>b.name.localeCompare(a.name,'zh-Hant')); break;
        case 'cat-asc': list.sort((a,b)=>a.category.localeCompare(b.category,'zh-Hant') || a.name.localeCompare(b.name,'zh-Hant')); break;
        case 'sum-desc': list.sort((a,b)=>b.sum-a.sum); break;
        case 'sum-asc': list.sort((a,b)=>a.sum-b.sum); break;
        case 'avg-desc': list.sort((a,b)=>b.avg-a.avg); break;
        case 'avg-asc': list.sort((a,b)=>a.avg-b.avg); break;
        case 'max-desc': list.sort((a,b)=>b.maxD-a.maxD); break;
        case 'max-asc': list.sort((a,b)=>a.maxD-b.maxD); break;
      }
      return list;
    }

    function renderTrend(){
      if(!currentStore || !stores.has(currentStore)) return;
      const mode=document.getElementById('trendMode').value;
      const wrapFacet=document.getElementById('facetWrap');
      const wrapMulti=document.getElementById('multiWrap');
      const baseList=getTrendFilteredMachines();

      if(mode==='FACET'){
        wrapMulti.style.display='none'; wrapFacet.style.display='grid';
        renderFacet(baseList.map(x=>x.name));
      } else {
        wrapFacet.style.display='none'; wrapMulti.style.display='block';
        let names = baseList.map(x=>x.name);
        const topN=document.getElementById('trendTopN').value;
        if(topN!=='ALL'){ const n=parseInt(topN,10); if(!isNaN(n)) names=names.slice(0,n); }
        renderTrendMulti(names);
      }
      renderTrendTable(baseList);
    }

    function renderTrendMulti(names){
      const S=stores.get(currentStore);
      const dates=Array.from(S.dates).filter(d=>d>=range.from && d<=range.to).sort();

      const series=names.map((name)=> {
        const by=S.byMachine[name]?.byDate||{};
        const points=dates.map(d=>({x:Date.parse(d+'T00:00:00Z'), y:(by[d]||0)}));
        const goods = goodsToNames((machineMeta.get(name)||{}).goods||'');
        return {name, goods, points};
      });
      trendChart.setData(series);
    }

    function renderFacet(names){
      const wrap=document.getElementById('facetWrap');
      const S=stores.get(currentStore);
      const dates=Array.from(S.dates).filter(d=>d>=range.from && d<=range.to).sort();

      const total=names.length;
      const pageSize=parseInt(document.getElementById('facetPageSize').value,10) || 12;
      facetState.pageSize = pageSize;
      const totalPages = Math.max(1, Math.ceil(Math.max(0,total)/pageSize));
      if(facetState.page>totalPages) facetState.page=totalPages;
      document.getElementById('facetPageInfo').textContent = `${facetState.page} / ${totalPages}`;

      const start=(facetState.page-1)*pageSize;
      const pageNames=names.slice(start, start+pageSize);

      const unified = document.getElementById('facetUnifiedY').checked;
      let globalMax=1;
      if(unified){
        const ys=[];
        pageNames.forEach(name=>{
          const by=S.byMachine[name]?.byDate||{};
          dates.forEach(d=> ys.push(by[d]||0) );
        });
        globalMax = Math.max(1, ...ys);
      }

      wrap.innerHTML='';
      pageNames.forEach(name=>{
        const meta=machineMeta.get(name)||{};
        const cat=inferCategory(name, meta.category);
        const goods=goodsToNames(meta.goods||'');
        const by=S.byMachine[name]?.byDate||{};
        const vals=dates.map(d=> by[d]||0);
        const sum=vals.reduce((a,b)=>a+b,0);

        const card=document.createElement('div'); card.className='facet-card';
        const title=document.createElement('div'); title.className='facet-title';
        title.innerHTML=`<span>${name}</span><span class="facet-meta">${cat}｜合計 HKD ${fmt(Math.round(sum))}</span>`;
        const sub=document.createElement('div'); sub.className='facet-meta'; sub.textContent = goods?`上架：${goods}`:'上架：—';
        const canvas=document.createElement('canvas'); canvas.className='facet-canvas';
        const tip=document.createElement('div'); tip.className='tooltip'; tip.style.position='absolute'; tip.style.display='none';

        card.appendChild(title); card.appendChild(sub); card.appendChild(canvas); card.appendChild(tip); wrap.appendChild(card);

        const ctx=canvas.getContext('2d'); const dpr=window.devicePixelRatio||1; const W=canvas.clientWidth||220, H=120;
        canvas.width=Math.round(W*dpr); canvas.height=Math.round(H*dpr); ctx.scale(dpr,dpr);
        const p={l:28,r:8,t:10,b:20};
        const yVals=vals;
        const yMin=0;
        const yMax= unified ? globalMax : Math.max(1, ...yVals);
        const xTo=(i)=> p.l + (i/(Math.max(1,dates.length-1))) * (W-p.l-p.r);
        const yTo=(v)=> p.t + (1-(v-yMin)/(yMax-yMin||1)) * (H-p.t-p.b);

        const grid='#233046';
        ctx.strokeStyle=grid; ctx.lineWidth=1; ctx.beginPath();
        const ticks=5; for(let i=0;i<=ticks;i++){ const y=p.t + (i/ticks)*(H-p.t-p.b); ctx.moveTo(p.l,y); ctx.lineTo(W-p.r,y);} ctx.stroke();

        ctx.strokeStyle='#22d3ee'; ctx.lineWidth=1.6; ctx.beginPath();
        yVals.forEach((v,i)=>{ const x=xTo(i), y=yTo(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
        ctx.stroke();

        ctx.fillStyle='#94a3b8'; ctx.font='10px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.textBaseline='top';
        if(dates.length){ const first=new Date(Date.parse(dates[0]+'T00:00:00Z')); const last=new Date(Date.parse(dates[dates.length-1]+'T00:00:00Z'));
          ctx.fillText(`${first.getUTCMonth()+1}/${first.getUTCDate()}`, xTo(0), H-p.b+2);
          ctx.fillText(`${last.getUTCMonth()+1}/${last.getUTCDate()}`, xTo(dates.length-1), H-p.b+2);
        }

        canvas.addEventListener('mousemove', (e)=>{
          const rect=canvas.getBoundingClientRect(); const mx=e.clientX-rect.left;
          let best=0,bestDist=Infinity;
          for(let i=0;i<dates.length;i++){ const dx=Math.abs(xTo(i)-mx); if(dx<bestDist){bestDist=dx; best=i;} }
          const d=dates[best]; const h=by[d]||0;
          tip.innerHTML=`${formatOutDate(d)}<br/>HKD ${fmt(Math.round(h))}<br/>上架：${goods||'—'}`;
          tip.style.left=xTo(best)+'px'; tip.style.top=(yTo(yVals[best])-8)+'px'; tip.style.display='block';

          ctx.clearRect(0,0,W,H);
          ctx.strokeStyle=grid; ctx.lineWidth=1; ctx.beginPath();
          for(let i=0;i<=ticks;i++){ const y=p.t + (i/ticks)*(H-p.t-p.b); ctx.moveTo(p.l,y); ctx.lineTo(W-p.r,y);} ctx.stroke();
          ctx.strokeStyle='#22d3ee'; ctx.lineWidth=1.6; ctx.beginPath();
          yVals.forEach((v,i)=>{ const x=xTo(i), y=yTo(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
          ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(xTo(best), p.t); ctx.lineTo(xTo(best), H-p.b); ctx.stroke(); ctx.setLineDash([]);
        });
        canvas.addEventListener('mouseleave', ()=>{
          tip.style.display='none';
          ctx.clearRect(0,0,W,H);
          ctx.strokeStyle=grid; ctx.lineWidth=1; ctx.beginPath(); for(let i=0;i<=ticks;i++){ const y=p.t + (i/ticks)*(H-p.t-p.b); ctx.moveTo(p.l,y); ctx.lineTo(W-p.r,y);} ctx.stroke();
          ctx.strokeStyle='#22d3ee'; ctx.lineWidth=1.6; ctx.beginPath(); yVals.forEach((v,i)=>{ const x=xTo(i), y=yTo(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
          ctx.fillStyle='#94a3b8'; ctx.font='10px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.textBaseline='top';
          if(dates.length){ const first=new Date(Date.parse(dates[0]+'T00:00:00Z')); const last=new Date(Date.parse(dates[dates.length-1]+'T00:00:00Z'));
            ctx.fillText(`${first.getUTCMonth()+1}/${first.getUTCDate()}`, xTo(0), H-p.b+2);
            ctx.fillText(`${last.getUTCMonth()+1}/${last.getUTCDate()}`, xTo(dates.length-1), H-p.b+2);
          }
        });
      });
    }

    function renderTrendTable(baseList){
      if(!currentStore || !stores.has(currentStore)) return;
      const S=stores.get(currentStore); const dates=Array.from(S.dates).filter(d=>d>=range.from && d<=range.to).sort();
      const tbody=document.querySelector('#trendTable tbody'); tbody.innerHTML='';
      baseList.forEach(info=>{
        const name=info.name, goods=info.goods||'—'; const by=S.byMachine[name]?.byDate||{};
        dates.forEach(d=>{
          const h=by[d]||0;
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${formatOutDate(d)}</td><td>${name}</td><td>${fmt(Math.round(h))}</td><td>${goods}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    // 事件
    document.getElementById('uploadXlsx').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ const recs=await parseXlsx(f); ingest(recs); toast(`已載入 ${recs.length} 筆`); }catch(err){ toast('解析失敗：'+err.message); }
      e.target.value='';
    });

    // 下載模板（日期為文字；StoresMachines: store|machines）
    document.getElementById('downloadTemplate').addEventListener('click', async ()=>{
      const XLSX = await loadXLSX(); const wb=XLSX.utils.book_new();
      const raw=[['統計日期','設備編號(可忽略)','設備類型(可忽略)','機台號','門市名稱','線下投幣'],
        ['2025/09/01','','','SWK08左','石圍角',1],
        ['2025/09/01','','','SWK04右','石圍角',17],
        ['2025/09/02','','','SWK08左','石圍角',8]];
      const wsRaw=XLSX.utils.aoa_to_sheet(raw); wsRaw['A2'].t='s'; wsRaw['A3'].t='s'; wsRaw['A4'].t='s';
      XLSX.utils.book_append_sheet(wb, wsRaw, 'RawLog');

      const sm=[['store','machines'],['石圍角',6],['葵芳',12],['MegaBox',8]];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sm), 'StoresMachines');

      const items=[['code','name'],['PDPC0001','可口可樂'],['PDPC0002','雪碧']];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(items), 'Items');

      const meta=[['machine_name','category','goods','price','listed'],
        ['SWK08左','標準機','PDPC0001','$20','2025/09/01'],
        ['SWK04右','巨無霸','PDPC0002','$30','2025/09/02']];
      const wsMeta=XLSX.utils.aoa_to_sheet(meta); wsMeta['E2'].t='s'; wsMeta['E3'].t='s';
      XLSX.utils.book_append_sheet(wb, wsMeta, 'MachinesMeta');

      const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); const blob=new Blob([out],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='FunFun_template.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('模板已下載');
    });

    // 分店/期間
    document.getElementById('storeSelect').addEventListener('change', e=>{ currentStore=e.target.value; renderAll(); });
    function setQuick(n){
      if(!currentStore||!stores.has(currentStore)) return; const S=stores.get(currentStore); const ds=Array.from(S.dates).sort(); if(!ds.length) return;
      const to=ds[ds.length-1], toT=Date.parse(to), fromT=toT-(n-1)*86400000, fd=new Date(fromT);
      const f=new Date(Date.UTC(fd.getUTCFullYear(),fd.getUTCMonth(),fd.getUTCDate())).toISOString().slice(0,10);
      range.from=f; range.to=to; document.getElementById('fromDate').value=f; document.getElementById('toDate').value=to; renderAll();
    }
    document.getElementById('quick7').addEventListener('click', ()=>setQuick(7));
    document.getElementById('quick14').addEventListener('click', ()=>setQuick(14));
    document.getElementById('quick30').addEventListener('click', ()=>setQuick(30));
    document.getElementById('applyRange').addEventListener('click', ()=>{ const f=document.getElementById('fromDate').value, t=document.getElementById('toDate').value; if(f&&t&&f<=t){ range.from=f; range.to=t; renderAll(); } else toast('請選正確區間'); });

    // 控制
    document.getElementById('toggleMA').addEventListener('click', ()=>{ lineChart.showMA=!lineChart.showMA; renderAll(); });
    document.getElementById('resetLineZoom').addEventListener('click', ()=> lineChart.reset());

    ['filterSeries','passFilter','sortBy','topn'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>renderAll()));
    ['searchBox','priceMin','priceMax'].forEach(id=> document.getElementById(id).addEventListener('input', ()=>renderAll()));
    document.getElementById('resetBar').addEventListener('click', ()=>{
      document.getElementById('filterSeries').value='ALL';
      document.getElementById('passFilter').value='ALL';
      document.getElementById('sortBy').value='name-asc';
      document.getElementById('topn').value='全部';
      document.getElementById('searchBox').value='';
      document.getElementById('priceMin').value='';
      document.getElementById('priceMax').value='';
      renderAll();
    });

    ['trendMode','trendY','trendCat','trendTopN','trendSort'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{ if(id==='trendMode'){ facetState.page=1; } renderTrend(); }));
    document.getElementById('trendSearch').addEventListener('input', ()=>{ facetState.page=1; renderTrend(); });
    document.getElementById('facetPageSize').addEventListener('change', ()=>{ facetState.page=1; renderTrend(); });
    document.getElementById('facetPrev').addEventListener('click', ()=>{ if(facetState.page>1){ facetState.page--; renderTrend(); } });
    document.getElementById('facetNext').addEventListener('click', ()=>{ facetState.page++; renderTrend(); });

    // 初始
    document.getElementById('storeSelect').innerHTML='<option>（請先上載 XLSX）</option>';
    document.getElementById('sortBy').value='name-asc';
  </script>
</body>
</html>
